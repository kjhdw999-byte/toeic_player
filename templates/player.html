<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC LC Player - {{ username }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 { font-size: 24px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .username-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 500;
        }
        .logout-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.4); }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* í´ë” ì„ íƒ í™”ë©´ */
        .folder-view { display: block; }
        .folder-view h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 24px;
        }
        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        .folder-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .folder-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }
        .folder-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .folder-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .folder-count {
            font-size: 14px;
            opacity: 0.9;
        }

        /* íŒŒì¼ ì„ íƒ í™”ë©´ */
        .file-view { display: none; }
        .back-btn {
            background: #f0f0f0;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .back-btn:hover {
            background: #e0e0e0;
            transform: translateX(-5px);
        }
        .current-folder {
            font-size: 22px;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        .file-btn {
            padding: 20px;
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            word-break: break-all;
            transition: all 0.3s;
        }
        .file-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .file-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* í”Œë ˆì´ì–´ */
        .player-section { display: none; }
        .current-file {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 600;
        }
        audio { display: none; }
        .time-display {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            color: #666;
            font-size: 14px;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            margin: 15px 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .controls button { flex: 1; min-width: 80px; padding: 12px; }
        .btn-play {
            background: #667eea;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-play:hover {
            background: #5568d3;
        }
        .btn-skip {
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-skip:hover { background: #e0e0e0; }
        .add-marker-btn {
            width: 100%;
            padding: 15px;
            background: #2ecc71;
            color: white;
            font-size: 18px;
            margin: 20px 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .add-marker-btn:hover { 
            background: #27ae60;
            transform: translateY(-2px);
        }
        .marker-section-title {
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 20px;
            color: #333;
        }
        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .tab {
            padding: 12px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }
        .tab.active { background: #667eea; color: white; }
        .tab:hover:not(.active) { background: #e0e0e0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .marker {
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            transition: all 0.3s;
        }
        .marker:hover {
            background: #f0f0f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .marker.my-marker {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        .marker.my-marker:hover {
            background: #dcedc8;
        }
        .marker-info { flex: 1; }
        .marker-time {
            color: #667eea;
            font-weight: 600;
            margin-right: 10px;
        }
        .marker-owner {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }
        .marker-owner.me {
            background: #4caf50;
        }
        .marker-actions { display: flex; gap: 10px; }
        .btn-jump {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-jump:hover {
            background: #2980b9;
        }
        .btn-delete {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-delete:hover {
            background: #c0392b;
        }
        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .header { flex-direction: column; text-align: center; }
            .folder-grid { grid-template-columns: repeat(2, 1fr); }
            .file-list { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
            .controls button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§ TOEIC LC Player</h1>
        <div class="user-info">
            <div class="username-badge">{{ username }}</div>
            <button class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <!-- í´ë” ì„ íƒ í™”ë©´ -->
    <div class="card folder-view" id="folderView">
        <h2>ğŸ“‚ í´ë” ì„ íƒ</h2>
        <div class="folder-grid" id="folderGrid">
            {% if folder_structure %}
                {% for folder, files in folder_structure.items() %}
                <button class="folder-card" data-folder="{{ folder }}">
                    <div class="folder-icon">ğŸ“</div>
                    <div class="folder-name">{{ folder }}</div>
                    <div class="folder-count">{{ files|length }}ê°œ íŒŒì¼</div>
                </button>
                {% endfor %}
            {% else %}
                <div style="grid-column: 1/-1;">
                    <div class="empty-state">
                        <p>ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <p style="margin-top: 10px; font-size: 14px;">static/uploads í´ë”ì— íŒŒì¼ì„ ì¶”ê°€í•˜ì„¸ìš”</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- íŒŒì¼ ì„ íƒ í™”ë©´ -->
    <div class="card file-view" id="fileView">
        <button class="back-btn" id="backToFoldersBtn">â† í´ë”ë¡œ ëŒì•„ê°€ê¸°</button>
        <div class="current-folder" id="currentFolderName"></div>
        <div class="file-list" id="fileList"></div>
    </div>

    <!-- í”Œë ˆì´ì–´ -->
    <div class="card player-section" id="playerSection">
        <button class="back-btn" id="backToFilesBtn">â† íŒŒì¼ ëª©ë¡ìœ¼ë¡œ</button>
        <div class="current-file" id="currentFile"></div>
        <audio id="audio" preload="metadata"></audio>
        <div class="time-display">
            <span id="currentTime">00:00</span>
            <span id="duration">00:00</span>
        </div>
        <input type="range" id="progress" min="0" max="100" value="0" step="0.1">
        <div class="controls">
            <button class="btn-skip" id="skip-10">-10ì´ˆ</button>
            <button class="btn-skip" id="skip-5">-5ì´ˆ</button>
            <button class="btn-play" id="playPause">â–¶ ì¬ìƒ</button>
            <button class="btn-skip" id="skip5">+5ì´ˆ</button>
            <button class="btn-skip" id="skip10">+10ì´ˆ</button>
        </div>
        <button class="add-marker-btn" id="addMarkerBtn">â• ë§ˆì»¤ ì¶”ê°€</button>
        <h3 class="marker-section-title">ğŸ“Œ ë§ˆì»¤ ëª©ë¡</h3>
        <div class="tabs" id="userTabs"></div>
        <div id="markerContents"></div>
    </div>

    <script>
        const folderStructure = {{ folder_structure|tojson|safe }};

        let currentFolder = '';
        let currentFilename = '';
        const currentUsername = '{{ username }}';
        let allMarkers = {};
        let isSeeking = false;
        const audio = document.getElementById('audio');
        const progress = document.getElementById('progress');

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.folder-card').forEach(card => {
                card.addEventListener('click', function() {
                    const folder = this.getAttribute('data-folder');
                    selectFolder(folder);
                });
            });

            document.getElementById('backToFoldersBtn').addEventListener('click', backToFolders);
            document.getElementById('backToFilesBtn').addEventListener('click', backToFiles);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('playPause').addEventListener('click', togglePlay);
            document.getElementById('skip-10').addEventListener('click', () => skip(-10));
            document.getElementById('skip-5').addEventListener('click', () => skip(-5));
            document.getElementById('skip5').addEventListener('click', () => skip(5));
            document.getElementById('skip10').addEventListener('click', () => skip(10));
            document.getElementById('addMarkerBtn').addEventListener('click', addMarker);
        });

        function selectFolder(folder) {
            currentFolder = folder;
            document.getElementById('currentFolderName').textContent = 'ğŸ“ ' + folder;

            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            const files = folderStructure[folder] || [];

            if (files.length === 0) {
                fileList.innerHTML = '<div class="empty-state">ì´ í´ë”ì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            } else {
                files.forEach(file => {
                    const btn = document.createElement('button');
                    btn.className = 'file-btn';
                    const filename = file.split('/').pop();
                    btn.innerHTML = '<div class="file-icon">ğŸµ</div><div>' + filename + '</div>';
                    btn.setAttribute('data-file', file);
                    btn.addEventListener('click', function() {
                        loadAudio(this.getAttribute('data-file'));
                    });
                    fileList.appendChild(btn);
                });
            }

            document.getElementById('folderView').style.display = 'none';
            document.getElementById('fileView').style.display = 'block';
        }

        function backToFolders() {
            document.getElementById('folderView').style.display = 'block';
            document.getElementById('fileView').style.display = 'none';
        }

        function backToFiles() {
            document.getElementById('playerSection').style.display = 'none';
            document.getElementById('fileView').style.display = 'block';
        }

        function loadAudio(filename) {
            currentFilename = filename;
            audio.src = '/static/uploads/' + filename;
            document.getElementById('currentFile').textContent = 'ğŸµ ' + filename.split('/').pop();
            document.getElementById('fileView').style.display = 'none';
            document.getElementById('playerSection').style.display = 'block';
            loadAllMarkers();
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
        }

        function togglePlay() {
            const btn = document.getElementById('playPause');
            if (audio.paused) { 
                audio.play(); 
                btn.textContent = 'â¸ ì¼ì‹œì •ì§€'; 
            } else { 
                audio.pause(); 
                btn.textContent = 'â–¶ ì¬ìƒ'; 
            }
        }

        function skip(seconds) {
            audio.currentTime = Math.max(0, Math.min(audio.currentTime + seconds, audio.duration));
        }

        function addMarker() {
            const memo = (prompt('ë§ˆì»¤ ë¼ë²¨ ì…ë ¥ (ì„ íƒ):', '') || '').trim();

            if (!allMarkers[currentUsername]) {
                allMarkers[currentUsername] = [];
            }

            const newMarker = {
                time: audio.currentTime,
                label: (memo || ""),
                username: currentUsername,
                created_at: new Date().toISOString()
            };

            allMarkers[currentUsername].push(newMarker);
            allMarkers[currentUsername].sort((a, b) => a.time - b.time);

            saveMarkers(currentUsername);
            updateMarkerDisplay();
        }

        function saveMarkers(username) {
            if (username !== currentUsername) {
                alert('ì˜¤ë¥˜: ìì‹ ì˜ ë§ˆì»¤ë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                return;
            }

            fetch('/markers/' + currentFilename + '/' + username, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(allMarkers[username] || [])
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(err => {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + err);
            });
        }

        function loadAllMarkers() {
            fetch('/markers/' + currentFilename)
                .then(r => r.json())
                .then(data => {
                    allMarkers = data;

                    for (let user in allMarkers) {
                        allMarkers[user] = allMarkers[user].map(marker => {
                            if (!marker.username) {
                                marker.username = user;
                            }
                            return marker;
                        });
                    }

                    updateMarkerDisplay();
                })
                .catch(err => {
                    console.error('ë§ˆì»¤ ë¡œë“œ ì‹¤íŒ¨:', err);
                });
        }

        function updateMarkerDisplay() {
            const users = Object.keys(allMarkers).sort();
            const tabsContainer = document.getElementById('userTabs');
            tabsContainer.innerHTML = '';
            const contentsContainer = document.getElementById('markerContents');
            contentsContainer.innerHTML = '';

            users.forEach((user) => {
                const tab = document.createElement('button');
                tab.className = 'tab' + (user === currentUsername ? ' active' : '');
                const markerCount = (allMarkers[user] || []).length;
                tab.textContent = user + ' (' + markerCount + ')';
                if (user === currentUsername) {
                    tab.textContent += ' ğŸ‘¤';
                }
                tab.addEventListener('click', function() { switchTab(user); });
                tabsContainer.appendChild(tab);

                const content = document.createElement('div');
                content.className = 'tab-content' + (user === currentUsername ? ' active' : '');
                content.id = 'tab-' + user;
                const markers = allMarkers[user] || [];

                if (markers.length === 0) {
                    content.innerHTML = '<div class="empty-state">ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                } else {
                    markers.forEach((m, i) => {
                        const markerDiv = document.createElement('div');
                        const markerOwner = m.username || user;
                        const isMyMarker = (markerOwner === currentUsername);

                        markerDiv.className = 'marker' + (isMyMarker ? ' my-marker' : '');

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'marker-info';
                        infoDiv.innerHTML = 
                            '<span class="marker-time">[' + formatTime(m.time) + ']</span>' +
                            '<span>' + (m.label || "") + '</span>' +
                            '<span class="marker-owner' + (isMyMarker ? ' me' : '') + '">' + markerOwner + '</span>';

                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'marker-actions';

                        const jumpBtn = document.createElement('button');
                        jumpBtn.className = 'btn-jump';
                        jumpBtn.textContent = 'ì í”„';
                        jumpBtn.addEventListener('click', function() { jumpTo(m.time); });
                        actionsDiv.appendChild(jumpBtn);

                        if (markerOwner === currentUsername) {
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'btn-delete';
                            deleteBtn.textContent = 'ì‚­ì œ';
                            deleteBtn.addEventListener('click', function() { deleteMarker(user, i); });
                            actionsDiv.appendChild(deleteBtn);
                        }

                        markerDiv.appendChild(infoDiv);
                        markerDiv.appendChild(actionsDiv);
                        content.appendChild(markerDiv);
                    });
                }
                contentsContainer.appendChild(content);
            });
        }

        function switchTab(username) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + username).classList.add('active');
        }

        function jumpTo(time) {
            audio.currentTime = time;
            audio.play();
            document.getElementById('playPause').textContent = 'â¸ ì¼ì‹œì •ì§€';
        }

        function deleteMarker(username, index) {
            const marker = allMarkers[username][index];
            const markerOwner = marker.username || username;

            if (markerOwner !== currentUsername) {
                alert('ìì‹ ì˜ ë§ˆì»¤ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                return;
            }

            if (!confirm('ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            allMarkers[username].splice(index, 1);
            saveMarkers(username);
            updateMarkerDisplay();
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.href = '/logout';
            }
        }

        audio.addEventListener('loadedmetadata', () => {
            document.getElementById('duration').textContent = formatTime(audio.duration);
        });

        audio.addEventListener('timeupdate', () => {
            if (!isSeeking) {
                const percent = (audio.currentTime / audio.duration) * 100;
                progress.value = percent;
                document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
            }
        });

        progress.addEventListener('mousedown', () => { isSeeking = true; });
        progress.addEventListener('mouseup', () => {
            audio.currentTime = (progress.value / 100) * audio.duration;
            isSeeking = false;
        });
        progress.addEventListener('touchstart', () => { isSeeking = true; });
        progress.addEventListener('touchend', () => {
            audio.currentTime = (progress.value / 100) * audio.duration;
            isSeeking = false;
        });
    </script>
</body>
</html>
